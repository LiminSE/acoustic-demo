<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建筑声学演示工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: url('https://path-to-your-comic-background.jpg'); /* 替换为漫画网店风格背景图片 */
            background-size: cover;
            background-position: center;
            color: #333;
        }

        #levelBarContainer {
            position: relative;
            width: 90%;
            height: 50px;
            background-color: #b2e0e0;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
        }

        #levelBar {
            position: absolute;
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #39c5bb, #7ed3d3);
            border-radius: 25px;
            box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        #audioProgressContainer {
            position: relative;
            width: 90%;
            height: 20px;
            background-color: #b2e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
        }

        #audioProgress {
            position: absolute;
            height: 100%;
            width: 0%;
            background: orange; /* 橙色表示音乐播放进度 */
            border-radius: 10px;
            box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .levelValue {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #39c5bb;
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        canvas {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background-color: #f0f0f0;
            margin-bottom: 20px;
        }

        .description {
            margin: 20px;
            text-align: center;
            color: #39c5bb;
        }

        .button-container {
            margin: 20px;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #39c5bb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #7ed3d3;
        }

        .active-chart {
            display: block !important;
        }

        .hidden-chart {
            display: none !important;
        }

        .filter-switch {
            margin: 20px;
        }

        .time-display {
            font-size: 16px;
            color: #39c5bb;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>建筑声学演示工具</h1>
    <p class="description">此工具用于实时监测音频输入，您可以通过以下图表了解音频的频谱和电平信息。</p>

    <!-- 上传音源 -->
    <div class="filter-switch">
        <label for="audioUpload">上传音源:</label>
        <input type="file" id="audioUpload" accept="audio/mp3" onchange="loadUploadedAudio()">
    </div>

    <!-- 音量控制 -->
    <div class="filter-switch">
        <label for="volumeControl">音量:</label>
        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" onchange="setVolume()">
    </div>

    <!-- 上传音源响度控制 -->
    <div class="filter-switch">
        <label for="uploadedVolumeControl">上传音源响度:</label>
        <input type="range" id="uploadedVolumeControl" min="0" max="1" step="0.01" value="1" onchange="setUploadedVolume()">
    </div>

    <!-- 开关：截取10Hz以下频率 -->
    <div class="filter-switch">
        <label for="lowFreqFilter">
            <input type="checkbox" id="lowFreqFilter"> 截取10Hz以下频率（便于更好地观察频谱）
        </label>
    </div>

    <!-- 电平横条 -->
    <div id="levelBarContainer">
        <div id="levelBar"></div>
        <div id="levelValue" class="levelValue">0%</div>
    </div>

    <!-- 音乐播放进度条 -->
    <div id="audioProgressContainer">
        <div id="audioProgress"></div>
    </div>

    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>

    <!-- 图表切换按钮 -->
    <div class="button-container">
        <button onclick="switchChart('halfCircleField')">极坐标声场分布图</button>
        <button onclick="switchChart('halfCircleFieldUploaded')">上传音源极坐标声场分布图</button>
        <button onclick="switchChart('squareField')">网格化声场分布图</button>
        <button onclick="switchChart('squareFieldUploaded')">上传音源网格化声场分布图</button>
        <button onclick="switchChart('linearHalfCircleField')">频谱线性分布图</button>
        <button onclick="switchChart('linearHalfCircleFieldUploaded')">上传音源频谱线性分布图</button>
        <button onclick="switchChart('spectrumChart')">频率响应图</button>
        <button onclick="switchChart('vuChart')">音频电平表</button>
    </div>

    <!-- 图表容器 -->
    <div class="chart-container">
        <canvas id="halfCircleField" class="active-chart" width="400" height="200"></canvas>
        <canvas id="halfCircleFieldUploaded" class="hidden-chart" width="400" height="200"></canvas>
        <canvas id="squareField" class="hidden-chart" width="400" height="400"></canvas>
        <canvas id="squareFieldUploaded" class="hidden-chart" width="400" height="400"></canvas>
        <canvas id="linearHalfCircleField" class="hidden-chart" width="400" height="150"></canvas>
        <canvas id="linearHalfCircleFieldUploaded" class="hidden-chart" width="400" height="150"></canvas>
        <canvas id="spectrumChart" class="hidden-chart" width="600" height="200"></canvas>
        <canvas id="vuChart" class="hidden-chart" width="300" height="150"></canvas>
    </div>

    <div id="chartDescription" class="description"></div>

    <audio id="uploadedAudio" loop>
        <source src="audio/simulated_sound.mp3" type="audio/mpeg">
        您的浏览器不支持音频元素。
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let analyser;
        const bufferLength = 64; // 降低采样频率
        const dataArray = new Uint8Array(bufferLength);
        const uploadedDataArray = new Uint8Array(bufferLength); // 新增用于存储上传音源的数据
        const lowFreqFilterCheckbox = document.getElementById('lowFreqFilter');
        const charts = document.querySelectorAll('canvas');
        const halfCircleField = document.getElementById('halfCircleField').getContext('2d');
        const halfCircleFieldUploaded = document.getElementById('halfCircleFieldUploaded').getContext('2d');
        const squareField = document.getElementById('squareField').getContext('2d');
        const squareFieldUploaded = document.getElementById('squareFieldUploaded').getContext('2d');
        const linearHalfCircleField = document.getElementById('linearHalfCircleField').getContext('2d');
        const linearHalfCircleFieldUploaded = document.getElementById('linearHalfCircleFieldUploaded').getContext('2d');
        const spectrumCtx = document.getElementById('spectrumChart').getContext('2d');
        const vuCtx = document.getElementById('vuChart').getContext('2d');
        const uploadedAudio = document.getElementById('uploadedAudio');
        const volumeControl = document.getElementById('volumeControl');
        const uploadedVolumeControl = document.getElementById('uploadedVolumeControl');
        const audioProgress = document.getElementById('audioProgress');
        const timeDisplay = document.getElementById('timeDisplay');

        const spectrumChart = new Chart(spectrumCtx, {
            type: 'line',
            data: {
                labels: Array.from({ length: bufferLength }, (_, i) => i),
                datasets: [{
                    label: '频率响应',
                    data: Array(bufferLength).fill(0),
                    borderColor: '#39c5bb',
                    backgroundColor: 'rgba(57, 197, 187, 0.2)',
                    borderWidth: 1
                },
                {
                    label: '上传音源频率响应',
                    data: Array(bufferLength).fill(0),
                    borderColor: 'orange', // 修改为橙色
                    backgroundColor: 'rgba(255, 165, 0, 0.2)', // 修改为橙色
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: { 
                        title: { display: true, text: '频率 (Hz)' },
                        ticks: { stepSize: 10 }
                    },
                    y: {
                        title: { display: true, text: '振幅 (dB)' },
                        beginAtZero: true
                    }
                }
            }
        });

        const vuChart = new Chart(vuCtx, {
            type: 'bar',
            data: {
                labels: ['左声道', '右声道'],
                datasets: [{
                    label: '音频电平表',
                    data: [0, 0],
                    backgroundColor: ['rgba(57, 197, 187, 0.5)', 'rgba(126, 211, 211, 0.5)'],
                    borderRadius: 10,
                    borderWidth: 1
                },
                {
                    label: '上传音源电平',
                    data: [0, 0], // 新增上传音源电平数据
                    backgroundColor: 'orange', // 修改为橙色
                    borderRadius: 10,
                    borderWidth: 1
                }]
            },
            options: {
                scales: { 
                    x: { display: false },
                    y: { beginAtZero: true }
                }
            }
        });

        async function startMicrophone() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            return analyser;
        }

        function applyLowFreqFilter(dataArray) {
            const filteredData = new Uint8Array(dataArray.length);
            for (let i = 10; i < dataArray.length; i++) {
                filteredData[i] = dataArray[i];
            }
            return filteredData;
        }

        function loadUploadedAudio() {
            const file = document.getElementById('audioUpload').files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                uploadedAudio.src = url;
                uploadedAudio.play();

                // 解析上传的音源
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createBufferSource();
                fetch(url)
                    .then(response => response.arrayBuffer())
                    .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                    .then(audioBuffer => {
                        source.buffer = audioBuffer;
                        const analyser = audioContext.createAnalyser();
                        source.connect(analyser);
                        analyser.connect(audioContext.destination);
                        source.start();

                        // 获取上传音源的频率数据
                        const interval = setInterval(() => {
                            analyser.getByteFrequencyData(uploadedDataArray);
                            updateCharts();
                        }, 200); // 增加间隔时间以降低采样频率

                        // 更新音乐播放进度
                        uploadedAudio.ontimeupdate = function() {
                            const progress = (uploadedAudio.currentTime / uploadedAudio.duration) * 100;
                            audioProgress.style.width = `${progress}%`;
                            const currentTime = formatTime(uploadedAudio.currentTime);
                            const duration = formatTime(uploadedAudio.duration);
                            timeDisplay.textContent = `${currentTime} / ${duration}`;
                        };

                        uploadedAudio.onended = function() {
                            clearInterval(interval);
                        };
                    });
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function setVolume() {
            const volume = volumeControl.value;
            uploadedAudio.volume = volume; // 动态调节上传音源的响度
            analyser.getByteFrequencyData(dataArray); // 更新麦克风音源的频率数据
            updateCharts(); // 更新图表
        }

        function setUploadedVolume() {
            const uploadedVolume = uploadedVolumeControl.value;
            uploadedAudio.volume = uploadedVolume; // 动态调节上传音源的响度
        }

        function updateSoundSource() {
            // 删除模拟音源的功能
        }

        function drawHalfCircleField(dataArray) {
            halfCircleField.clearRect(0, 0, 400, 200);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const particleCount = 50;
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * i) / particleCount;
                const radius = (filteredData[i] / 256) * 90 + 20;
                const x = 200 + Math.cos(angle) * radius;
                const y = 180 - Math.sin(angle) * radius;
                halfCircleField.fillStyle = `rgba(57, 197, 187, 0.7)`;
                halfCircleField.beginPath();
                halfCircleField.arc(x, y, 4, 0, Math.PI * 2);
                halfCircleField.fill();
            }
        }

        function drawHalfCircleFieldUploaded(dataArray) {
            halfCircleFieldUploaded.clearRect(0, 0, 400, 200);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const particleCount = 50;
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * i) / particleCount;
                const radius = (uploadedDataArray[i] / 256) * 90 + 20;
                const x = 200 + Math.cos(angle) * radius;
                const y = 180 - Math.sin(angle) * radius;
                halfCircleFieldUploaded.fillStyle = `rgba(255, 165, 0, 0.7)`; // 橙色
                halfCircleFieldUploaded.beginPath();
                halfCircleFieldUploaded.arc(x, y, 4, 0, Math.PI * 2);
                halfCircleFieldUploaded.fill();
            }
        }

        function drawSquareField(dataArray) {
            squareField.clearRect(0, 0, 400, 400);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const cellSize = 40;
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const value = filteredData[i * 10 + j];
                    squareField.fillStyle = `rgba(57, 197, 187, ${value / 256})`;
                    squareField.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                }
            }
        }

        function drawSquareFieldUploaded(dataArray) {
            squareFieldUploaded.clearRect(0, 0, 400, 400);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const cellSize = 40;
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    const value = uploadedDataArray[i * 10 + j];
                    squareFieldUploaded.fillStyle = `rgba(255, 165, 0, ${value / 256})`; // 橙色
                    squareFieldUploaded.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                }
            }
        }

        function drawLinearHalfCircleField(dataArray) {
            linearHalfCircleField.clearRect(0, 0, 400, 150);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const barWidth = 10;
            const maxBarHeight = 120;
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (filteredData[i] / 256) * maxBarHeight;
                const x = (i * 4) + 10;
                const y = 150 - barHeight;
                linearHalfCircleField.fillStyle = `rgba(57, 197, 187, 0.8)`;
                linearHalfCircleField.fillRect(x, y, barWidth, barHeight);
            }
        }

        function drawLinearHalfCircleFieldUploaded(dataArray) {
            linearHalfCircleFieldUploaded.clearRect(0, 0, 400, 150);
            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            const barWidth = 10;
            const maxBarHeight = 120;
            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (uploadedDataArray[i] / 256) * maxBarHeight;
                const x = (i * 4) + 10;
                const y = 150 - barHeight;
                linearHalfCircleFieldUploaded.fillStyle = `rgba(255, 165, 0, 0.8)`; // 橙色
                linearHalfCircleFieldUploaded.fillRect(x, y, barWidth, barHeight);
            }
        }

        function updateCharts() {
            analyser.getByteFrequencyData(dataArray);

            const filteredData = lowFreqFilterCheckbox.checked ? applyLowFreqFilter(dataArray) : dataArray;

            spectrumChart.data.datasets[0].data = filteredData.slice(0, 64); // 更新为新的bufferLength
            spectrumChart.data.datasets[1].data = uploadedDataArray.slice(0, 64); // 更新上传音源数据
            spectrumChart.update();

            vuChart.data.datasets[0].data = [Math.max(...filteredData.slice(0, 32)), Math.max(...filteredData.slice(32, 64))]; // 更新为新的bufferLength
            vuChart.data.datasets[1].data = [Math.max(...uploadedDataArray.slice(0, 32)), Math.max(...uploadedDataArray.slice(32, 64))]; // 更新上传音源电平
            vuChart.update();

            const level = Math.max(...filteredData) / 256;
            document.getElementById('levelBar').style.width = `${level * 100}%`;
            document.getElementById('levelValue').textContent = `${Math.round(level * 100)}%`;

            drawHalfCircleField(filteredData);
            drawHalfCircleFieldUploaded(uploadedDataArray);
            drawSquareField(filteredData);
            drawSquareFieldUploaded(uploadedDataArray);
            drawLinearHalfCircleField(filteredData);
            drawLinearHalfCircleFieldUploaded(uploadedDataArray);

            requestAnimationFrame(updateCharts);
        }

        function switchChart(chartId) {
            charts.forEach(chart => {
                if (chart.id === chartId) {
                    chart.classList.add('active-chart');
                    chart.classList.remove('hidden-chart');
                } else {
                    chart.classList.remove('active-chart');
                    chart.classList.add('hidden-chart');
                }
            });

            let descriptionText = '';
            switch (chartId) {
                case 'halfCircleField':
                    descriptionText = '极坐标声场分布图展示了音频的空间分布，常用于分析声音的方向性和空间感。';
                    break;
                case 'halfCircleFieldUploaded':
                    descriptionText = '上传音源极坐标声场分布图展示了上传音源的空间分布，便于与麦克风音源进行对比。';
                    break;
                case 'squareField':
                    descriptionText = '网格化声场分布图用于模拟声学空间的热力图，分析频率强度的分布。';
                    break;
                case 'squareFieldUploaded':
                    descriptionText = '上传音源网格化声场分布图展示了上传音源的频率强度分布，便于与麦克风音源进行对比。';
                    break;
                case 'linearHalfCircleField':
                    descriptionText = '频谱线性分布图帮助理解声音频率的变化，适用于频率响应的分析。';
                    break;
                case 'linearHalfCircleFieldUploaded':
                    descriptionText = '上传音源频谱线性分布图展示了上传音源的频率变化，便于与麦克风音源进行对比。';
                    break;
                case 'spectrumChart':
                    descriptionText = '频率响应图展示了不同频率的能量分布，常用于音频处理和调音。';
                    break;
                case 'vuChart':
                    descriptionText = '音频电平表用于显示音频的电平强度，广泛应用于音频设备调试和声音监控。';
                    break;
                default:
                    descriptionText = '请选择一个图表进行查看。';
            }
            document.getElementById('chartDescription').textContent = descriptionText;
        }

        startMicrophone()
            .then((analyserInstance) => {
                analyser = analyserInstance;
                updateCharts();
            })
            .catch(err => console.error('麦克风访问失败:', err));
    </script>
</body>
</html>
