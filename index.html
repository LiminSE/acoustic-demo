<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建筑声学演示工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #e0f7f7;
        }

        #levelBarContainer {
            position: relative;
            width: 90%;
            height: 50px;
            background-color: #b2e0e0;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
        }

        #levelBar {
            position: absolute;
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #39c5bb, #7ed3d3);
            border-radius: 25px;
            box-shadow: inset 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        .levelValue {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            color: #39c5bb;
        }

        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        canvas {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            background-color: #f0f0f0;
            margin-bottom: 20px;
        }

        .description {
            margin: 20px;
            text-align: center;
            color: #39c5bb;
        }

        .button-container {
            margin: 20px;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #39c5bb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #7ed3d3;
        }

        .active-chart {
            display: block !important;
        }

        .hidden-chart {
            display: none !important;
        }
    </style>
</head>
<body>
    <h1>建筑声学演示工具</h1>
    <p class="description">此工具用于实时监测音频输入，您可以通过以下图表了解音频的频谱和电平信息。</p>

    <!-- 电平横条 -->
    <div id="levelBarContainer">
        <div id="levelBar"></div>
        <div id="levelValue" class="levelValue">0%</div>
    </div>

    <!-- 图表切换按钮 -->
    <div class="button-container">
        <button onclick="switchChart('halfCircleField')">半圆声场图</button>
        <button onclick="switchChart('squareField')">正方形声场图</button>
        <button onclick="switchChart('linearHalfCircleField')">线性半圆图</button>
        <button onclick="switchChart('spectrumChart')">频谱图</button>
        <button onclick="switchChart('vuChart')">VU 表</button>
    </div>

    <!-- 图表容器 -->
    <div class="chart-container">
        <canvas id="halfCircleField" class="active-chart" width="400" height="200"></canvas>
        <canvas id="squareField" class="hidden-chart" width="400" height="400"></canvas>
        <canvas id="linearHalfCircleField" class="hidden-chart" width="400" height="150"></canvas>
        <canvas id="spectrumChart" class="hidden-chart" width="600" height="200"></canvas>
        <canvas id="vuChart" class="hidden-chart" width="300" height="150"></canvas>
    </div>

    <div id="chartDescription" class="description"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function startMicrophone() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;
            return analyser;
        }

        let analyser;
        const bufferLength = 128;
        const dataArray = new Uint8Array(bufferLength);

        const charts = document.querySelectorAll('canvas');
        const halfCircleField = document.getElementById('halfCircleField').getContext('2d');
        const squareField = document.getElementById('squareField').getContext('2d');
        const linearHalfCircleField = document.getElementById('linearHalfCircleField').getContext('2d');

        const spectrumCtx = document.getElementById('spectrumChart').getContext('2d');
        const vuCtx = document.getElementById('vuChart').getContext('2d');

        const spectrumChart = new Chart(spectrumCtx, {
            type: 'line',
            data: {
                labels: Array.from({ length: bufferLength }, (_, i) => i),
                datasets: [{
                    label: '频谱',
                    data: Array(bufferLength).fill(0),
                    borderColor: '#39c5bb',
                    backgroundColor: 'rgba(57, 197, 187, 0.2)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { x: { display: false }, y: { beginAtZero: true } }
            }
        });

        const vuChart = new Chart(vuCtx, {
            type: 'bar',
            data: {
                labels: ['左声道', '右声道'],
                datasets: [{
                    label: 'VU 表',
                    data: [0, 0],
                    backgroundColor: ['#39c5bb', '#7ed3d3'],
                    borderWidth: 1
                }]
            },
            options: {
                scales: { x: { display: false }, y: { beginAtZero: true } }
            }
        });

        function drawHalfCircleField(dataArray) {
            halfCircleField.clearRect(0, 0, 400, 200);

            const particleCount = 50;
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * i) / particleCount;
                const radius = (dataArray[i] / 256) * 90 + 20;
                const x = 200 + Math.cos(angle) * radius;
                const y = 180 - Math.sin(angle) * radius;
                halfCircleField.fillStyle = `rgba(57, 197, 187, 0.7)`;
                halfCircleField.beginPath();
                halfCircleField.arc(x, y, 4, 0, Math.PI * 2);
                halfCircleField.fill();
            }

            // 添加频率标注
            for (let i = 0; i <= particleCount; i += 10) {
                const angle = (Math.PI * i) / particleCount;
                const radius = 100;
                const x = 200 + Math.cos(angle) * radius;
                const y = 180 - Math.sin(angle) * radius;
                const frequency = (i * 200).toFixed(0);
                halfCircleField.fillStyle = '#000';
                halfCircleField.font = '12px Arial';
                halfCircleField.fillText(`${frequency} Hz`, x - 20, y);
            }
        }

        function drawSquareField(dataArray) {
            squareField.clearRect(0, 0, 400, 400);
            const gridSize = 12;
            const cellSize = 30;

            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const intensity = dataArray[(i * gridSize + j) % dataArray.length] / 256;
                    squareField.fillStyle = `rgba(57, 197, 187, ${intensity})`;
                    squareField.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                }
            }
        }

        function drawLinearHalfCircleField(dataArray) {
            linearHalfCircleField.clearRect(0, 0, 400, 150);

            const barWidth = 10;
            const maxBarHeight = 120;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (dataArray[i] / 256) * maxBarHeight;
                const x = (i * 4) + 10;
                const y = 150 - barHeight;
                linearHalfCircleField.fillStyle = `rgba(57, 197, 187, 0.8)`;
                linearHalfCircleField.fillRect(x, y, barWidth, barHeight);
            }
        }

        function updateCharts() {
            analyser.getByteFrequencyData(dataArray);

            // 更新频谱图
            spectrumChart.data.datasets[0].data = dataArray.slice(0, 128);
            spectrumChart.update();

            // 更新VU表
            vuChart.data.datasets[0].data = [Math.max(...dataArray.slice(0, 64)), Math.max(...dataArray.slice(64, 128))];
            vuChart.update();

            // 更新电平条
            const level = Math.max(...dataArray) / 256;
            document.getElementById('levelBar').style.width = `${level * 100}%`;
            document.getElementById('levelValue').textContent = `${Math.round(level * 100)}%`;

            drawHalfCircleField(dataArray);
            drawSquareField(dataArray);
            drawLinearHalfCircleField(dataArray);

            requestAnimationFrame(updateCharts);
        }

        function switchChart(chartId) {
            charts.forEach(chart => {
                if (chart.id === chartId) {
                    chart.classList.add('active-chart');
                    chart.classList.remove('hidden-chart');
                } else {
                    chart.classList.remove('active-chart');
                    chart.classList.add('hidden-chart');
                }
            });

            // 更新说明
            let descriptionText = '';
            switch (chartId) {
                case 'halfCircleField':
                    descriptionText = '半圆声场图显示了音频在空间中的分布，通常用于分析声音的方向性和空间感。';
                    break;
                case 'squareField':
                    descriptionText = '正方形声场图展示了频率强度分布的网格，常用于模拟声学空间的热力图。';
                    break;
                case 'linearHalfCircleField':
                    descriptionText = '线性半圆图用于显示频谱的变化，可以帮助理解声音的频率分布。';
                    break;
                case 'spectrumChart':
                    descriptionText = '频谱图展示了不同频率的能量分布，常用于音频处理和调音。';
                    break;
                case 'vuChart':
                    descriptionText = 'VU表用于显示声音的电平强度，广泛应用于音频设备调试和声音监控。';
                    break;
                default:
                    descriptionText = '请选择一个图表进行查看。';
            }
            document.getElementById('chartDescription').textContent = descriptionText;
        }

        startMicrophone()
            .then((analyserInstance) => {
                analyser = analyserInstance;
                updateCharts();
            })
            .catch(err => console.error('麦克风访问失败:', err));
    </script>
</body>
</html>
